# Dysruption CVA v1.1 - GitHub Actions Workflow
# Runs CVA verification on push and pull requests

name: CVA Verification

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog litellm loguru pylint bandit gitpython pyyaml requests
          
      - name: Run CVA Verification
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python cva.py --dir . --spec spec.txt --verbose
          
      - name: Upload Verification Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cva-verification-report
          path: |
            REPORT.md
            verdict.json
            criteria.json
          retention-days: 30
          
      - name: Check Verdict
        run: |
          if [ -f verdict.json ]; then
            VERDICT=$(python -c "import json; print(json.load(open('verdict.json'))['ci_cd']['success'])")
            if [ "$VERDICT" = "True" ]; then
              echo "✅ CVA Verification PASSED"
              exit 0
            else
              echo "❌ CVA Verification FAILED"
              cat REPORT.md
              exit 1
            fi
          else
            echo "⚠️ No verdict.json found"
            exit 1
          fi
          
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## CVA Verification Report\n\n';
            
            try {
              const verdict = JSON.parse(fs.readFileSync('verdict.json', 'utf8'));
              const passed = verdict.ci_cd.success;
              
              comment += `**Verdict**: ${passed ? '✅ PASS' : '❌ FAIL'}\n`;
              comment += `**Score**: ${verdict.overall_score}/10\n`;
              comment += `**Criteria Passed**: ${verdict.passed_criteria}/${verdict.total_criteria}\n\n`;
              
              if (!passed) {
                comment += '### Failed Criteria\n\n';
                verdict.criteria
                  .filter(c => c.verdict === 'FAIL')
                  .forEach(c => {
                    comment += `- ❌ **${c.type.toUpperCase()} #${c.id}**: ${c.description}\n`;
                  });
              }
            } catch (e) {
              comment += '⚠️ Could not parse verdict.json\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
          
      - name: Run Unit Tests
        run: |
          pytest tests/ -v --cov=modules --cov-report=xml
          
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
